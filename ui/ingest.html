<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ingest Documents</title>
</head>
<body>
  <h2>Upload & Ingest Documents</h2>
  <input id="fileInput" type="file" multiple>
  <button onclick="uploadFilesAndIngest()">Upload & Ingest</button>
  <div id="uploadStatus"></div>

  <p><a href="compare.html">Go to Compare</a> | <a href="rag.html">Go to RAG</a></p>

  <script src="common.js"></script>
  <script>
    checkSessionOrRedirect();
    const { project_name, user_id, session_id } = getSessionInfo();

    async function uploadFilesAndIngest() {
      const files = document.getElementById('fileInput').files;
      const statusDiv = document.getElementById('uploadStatus');
      if (!files.length) { statusDiv.innerText = "Choose at least one file"; return; }

      const docLocs = [];
      for (const file of files) {
        statusDiv.innerText = `Getting upload URL for ${file.name}...`;
        const presignRes = await fetch(API_URL, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({
            route: "/get_presigned_url",
            project_name,
            filename: file.name,
            content_type: file.type || "application/octet-stream",
            file_size: file.size
          })
        });
        const { url, doc_loc } = await presignRes.json();

        const uploadRes = await fetch(url, {
          method: "PUT",
          headers: { "Content-Type": file.type || "application/octet-stream" },
          body: file
        });
        if (!uploadRes.ok) { statusDiv.innerText = `Upload failed: ${file.name}`; return; }

        docLocs.push(doc_loc);
      }

      const ingestPayload = {
        route: "/ingest_data",
        project_name, user_id, session_id,
        doc_locs: docLocs,
        ingest_source: "ui",
        source_path: "browser_upload"
      };
      const ingestRes = await fetch(API_URL, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(ingestPayload)
      });
      renderJSON("uploadStatus", await ingestRes.json());
    }
  </script>
</body>
</html>
